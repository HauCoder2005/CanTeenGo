<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Giỏ hàng</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:0; }
        header { background-color: #ff6600; color:white; padding: 20px; text-align:center; }
        main { display: flex; flex-wrap: wrap; gap: 20px; padding:20px; }
        .food-card { border:1px solid #ddd; border-radius:8px; width:220px; text-align:center; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        .food-card img { width:100%; height:150px; object-fit:cover; }
        .food-card h3 { margin:10px 0; font-size:18px; }
        .food-card p { margin:5px 0; color:#555; }
        .food-card input { width: 50px; text-align: center; }
        .food-card button { background-color:#ff6600; color:white; border:none; padding:10px 15px; margin:10px 0; cursor:pointer; border-radius:5px; }
        .food-card button:hover { background-color:#e65c00; }
        .cart { position: fixed; right: 20px; top: 80px; width: 300px; border:1px solid #ddd; padding:10px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
        .cart h3 { margin-top:0; }
        .cart-item { display:flex; justify-content: space-between; margin-bottom:5px; }
        .cart-item span { display:inline-block; }
        .cart-item button { background:red; border:none; color:white; cursor:pointer; border-radius:3px; padding:2px 5px; }
        .checkout-btn { background:#28a745; color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:5px; width:100%; }
    </style>
</head>
<body>
<header>
    <h1>Đặt món hôm nay</h1>
</header>

<main>
    <div th:each="food : ${listFood}" class="food-card">
        <img th:src="@{'/images/' + ${food.image}}" alt="food image">
        <h3 th:text="${food.food_name}">Tên món</h3>
        <p th:text="'Giá: ' + ${#numbers.formatDecimal(food.price, 0, 'COMMA', 2, 'POINT')} + ' VNĐ'">Giá</p>
        <p th:text="'Số lượng: ' + ${food.available_quantity}">Số lượng</p>
        <input type="number" min="1" th:attr="max=${food.available_quantity}" value="1" class="qty">
        <button type="button" th:attr="data-id=${food.id}, data-name=${food.food_name}, data-price=${food.price}">Thêm vào giỏ</button>
    </div>
</main>

<div class="cart">
    <h3>Giỏ hàng</h3>
    <div id="cartItems"></div>
    <p>Tổng: <span id="totalPrice">0</span> VNĐ</p>
    <select id="paymentMethod">
        <option value="Tiền mặt">Tiền mặt</option>
        <option value="Chuyển khoản">Chuyển khoản</option>
    </select>
    <button class="checkout-btn">Đặt hàng</button>
</div>

<script>
    let cart = [];

    function updateCart() {
        const cartItemsDiv = document.getElementById('cartItems');
        const totalPriceSpan = document.getElementById('totalPrice');
        cartItemsDiv.innerHTML = '';
        let total = 0;
        cart.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `<span>${item.name} x${item.qty}</span>
                             <button data-index="${index}">X</button>`;
            cartItemsDiv.appendChild(div);
            total += item.price * item.qty;
        });
        totalPriceSpan.textContent = total.toLocaleString('vi-VN');

        // Xóa item
        document.querySelectorAll('.cart-item button').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = parseInt(btn.getAttribute('data-index'));
                cart.splice(idx,1);
                updateCart();
            });
        });
    }

    document.querySelectorAll('.food-card button').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id'));
            const name = btn.getAttribute('data-name');
            const price = parseFloat(btn.getAttribute('data-price'));
            const qtyInput = btn.previousElementSibling;
            const qty = parseInt(qtyInput.value);

            const exist = cart.find(i => i.id === id);
            if (exist) {
                exist.qty += qty;
            } else {
                cart.push({id, name, price, qty});
            }
            updateCart();
        });
    });

    document.querySelector('.checkout-btn').addEventListener('click', () => {
        if(cart.length === 0) { alert('Chưa có món nào trong giỏ!'); return; }

        const foodIds = cart.map(item => item.id);
        const quantities = cart.map(item => item.qty);
        const paymentMethod = document.getElementById('paymentMethod').value;

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/order/checkout';

        foodIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'foodIds';
            input.value = id;
            form.appendChild(input);
        });

        quantities.forEach(qty => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'quantities';
            input.value = qty;
            form.appendChild(input);
        });

        const inputPayment = document.createElement('input');
        inputPayment.type = 'hidden';
        inputPayment.name = 'paymentMethod';
        inputPayment.value = paymentMethod;
        form.appendChild(inputPayment);

        document.body.appendChild(form);
        form.submit();
    });
</script>

</body>
</html>
